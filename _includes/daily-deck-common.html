<style>
.domain-deck { margin-top: 1rem; }
.domain-deck__toolbar { border: 1px solid rgba(15, 23, 42, 0.10); border-radius: 14px; padding: 12px; background: rgba(248, 250, 252, 0.72); }
.domain-deck__row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between; }
.domain-deck__row--meta { margin-top: 8px; }
.domain-deck__label { display: inline-flex; gap: 8px; align-items: center; font-size: 12px; font-weight: 900; color: rgba(15, 23, 42, 0.82); }
.domain-deck__select, .domain-deck__input { border: 1px solid rgba(15, 23, 42, 0.14); border-radius: 10px; padding: 6px 10px; background: #fff; font-size: 13px; }
.domain-deck__input { width: 150px; }
.domain-deck__input--wide { width: 260px; }
.domain-deck__btn { border: 1px solid rgba(15, 23, 42, 0.14); background: #fff; border-radius: 12px; padding: 8px 12px; font-size: 13px; font-weight: 900; letter-spacing: -0.2px; cursor: pointer; text-decoration: none !important; display: inline-flex; align-items: center; justify-content: center; }
.domain-deck__btn:hover { background: rgba(226, 232, 240, 0.70); }
.domain-deck__btn--primary { background: linear-gradient(135deg, {{ include.accent }}, {{ include.accent }}cc); color: #fff; border-color: rgba(15, 23, 42, 0.10); }
.domain-deck__btn--primary:hover { filter: brightness(0.98); }
.domain-deck__btn--ghost { background: rgba(255, 255, 255, 0.65); }
.domain-deck__nav-links { display: flex; gap: 8px; }
.domain-deck__nav-pill { display: inline-flex; align-items: center; gap: 4px; padding: 6px 14px; border-radius: 20px; background: linear-gradient(135deg, {{ include.accent_light }}, {{ include.accent_light }}); border: 1px solid {{ include.accent_border }}; font-size: 12px; font-weight: 800; color: {{ include.accent }}; text-decoration: none !important; transition: all 0.15s ease; }
.domain-deck__nav-pill:hover { border-color: {{ include.accent }}55; transform: translateY(-1px); box-shadow: 0 2px 8px {{ include.accent }}22; }
.domain-deck__meta { display: flex; gap: 12px; align-items: center; font-size: 12px; font-weight: 900; color: rgba(15, 23, 42, 0.76); width: 100%; justify-content: space-between; }
.domain-deck__kbd { font-weight: 900; color: rgba(15, 23, 42, 0.62); }
.domain-deck__layout { margin-top: 12px; display: grid; gap: 12px; grid-template-columns: 360px 1fr; align-items: start; }
@media (max-width: 66.49rem) { .domain-deck__layout { grid-template-columns: 1fr; } .domain-deck__input--wide { width: 100%; } }
.domain-deck__list { border: 1px solid rgba(15, 23, 42, 0.10); border-radius: 14px; background: #fff; overflow: hidden; }
.domain-deck__items { max-height: calc(100vh - 280px); overflow: auto; }
@media (max-width: 66.49rem) { .domain-deck__items { max-height: 44vh; } }
.domain-deck__item { display: grid; gap: 6px; padding: 10px 10px; border-bottom: 1px solid rgba(15, 23, 42, 0.08); cursor: pointer; }
.domain-deck__item:hover { background: rgba(248, 250, 252, 0.85); }
.domain-deck__item.is-active { background: {{ include.accent_light }}; }
.domain-deck__item-title { font-size: 13px; font-weight: 900; letter-spacing: -0.2px; color: rgba(15, 23, 42, 0.90); }
.domain-deck__item-tagline { display: flex; gap: 8px; align-items: center; justify-content: space-between; }
.domain-deck__pill { display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 999px; font-size: 12px; font-weight: 900; color: rgba(15, 23, 42, 0.82); background: rgba(226, 232, 240, 0.75); border: 1px solid rgba(15, 23, 42, 0.10); }
.domain-deck__detail { border: 1px solid rgba(15, 23, 42, 0.10); border-radius: 14px; background: #fff; padding: 12px; }
.domain-deck__detail-head { display: grid; gap: 10px; border-bottom: 1px solid rgba(15, 23, 42, 0.10); padding-bottom: 10px; margin-bottom: 10px; }
.domain-deck__tag { display: inline-flex; width: fit-content; align-items: center; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 900; color: rgba(15, 23, 42, 0.86); background: rgba(226, 232, 240, 0.75); border: 1px solid rgba(15, 23, 42, 0.10); }
.domain-deck__title { font-size: 20px; font-weight: 900; letter-spacing: -0.4px; color: #0f172a; line-height: 1.3; }
.domain-deck__detail-actions { display: flex; gap: 10px; flex-wrap: wrap; }
.domain-deck__panes { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.domain-deck__pane { border: 1px solid rgba(15, 23, 42, 0.08); border-radius: 12px; background: rgba(248, 250, 252, 0.65); padding: 10px; }
.domain-deck__pane--wide { grid-column: 1 / -1; }
.domain-deck--exam .domain-deck__panes { grid-template-columns: 1fr; }
.domain-deck--exam .domain-deck__pane:not(.domain-deck__pane--wide) { display: none; }
.domain-deck--exam .domain-deck__pane--wide { grid-column: auto; }
.domain-deck__pane-title { font-size: 12px; font-weight: 900; color: rgba(15, 23, 42, 0.75); margin-bottom: 6px; }
.domain-deck__pane-body { font-size: 13px; line-height: 1.5; color: rgba(15, 23, 42, 0.92); }
.domain-deck__pane-body code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; padding: 2px 6px; border-radius: 8px; background: {{ include.accent_light }}; border: 1px solid {{ include.accent_border }}; color: {{ include.accent }}; margin-right: 6px; display: inline-block; margin-bottom: 6px; }
.domain-deck__pane-body table { width: 100% !important; font-size: 12px; }
.domain-deck__pane-body table td, .domain-deck__pane-body table th { padding: 6px 8px; white-space: normal; }
.domain-deck__pane-body table thead th { white-space: nowrap; }
</style>

<script>
(function() {
  var root = document.getElementById('domainDeckRoot');
  if (!root) return;

  var topicsUrl = root.getAttribute('data-topics-url');
  var examUrl = root.getAttribute('data-exam-url') || '';
  var domain = root.getAttribute('data-domain') || 'TOPIC';

  var elStatus = document.getElementById('domainDeckStatus');
  var elMode = document.getElementById('domainDeckMode');
  var elSearch = document.getElementById('domainDeckSearch');
  var elList = document.getElementById('domainDeckList');
  var elTag = document.getElementById('domainDeckTag');
  var elTitle = document.getElementById('domainDeckTitle');
  var elDef = document.getElementById('domainDeckDefinition');
  var elComponents = document.getElementById('domainDeckComponents');
  var elMnemonic = document.getElementById('domainDeckMnemonic');
  var elOpenLink = document.getElementById('domainDeckOpenLink');
  var btnPrev = document.getElementById('domainDeckPrev');
  var btnNext = document.getElementById('domainDeckNext');

  // Pane refs (exam cards show only Quick Reference)
  var paneDef = elDef && elDef.closest ? elDef.closest('.domain-deck__pane') : null;
  var paneComponents = elComponents && elComponents.closest ? elComponents.closest('.domain-deck__pane') : null;
  var paneMnemonic = elMnemonic && elMnemonic.closest ? elMnemonic.closest('.domain-deck__pane') : null;
  var paneMnemonicTitle = paneMnemonic ? paneMnemonic.querySelector('.domain-deck__pane-title') : null;
  var mnemonicTitleDefault = paneMnemonicTitle ? paneMnemonicTitle.textContent : '암기법/핵심 구문';

  var STORAGE_PREFIX = 'pe' + domain + 'Deck:v1:';
  var examRows = [];
  var topicRows = [];
  var cardsAll = [];
  var cards = [];
  var idx = 0;
  var pageCache = new Map();

  function safeGet(key, fallback) { try { var v = localStorage.getItem(key); if (!v) return fallback; return JSON.parse(v); } catch (e) { return fallback; } }
  function safeSet(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch (e) {} }
  function normalizeText(s) { return (s || '').replace(/\s+/g, ' ').trim(); }
  function shortParentLabel(s) { var t = normalizeText(s || ''); t = t.replace(/^\d+\.\s*/, ''); return t; }
  function escapeHtml(s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;').replace(/'/g, '&#39;'); }
  function setStatus() { elStatus.textContent = (cards.length ? (idx + 1) + ' / ' + cards.length : '0') + ' · 후보 ' + cardsAll.length; }

  function topicGroupForUrl(url) {
    if (!url) return 'etc';
    var match = url.match(/\/docs\/[a-z]+\/(\d+)-/);
    if (match) return match[1];
    return 'etc';
  }

  function applyModeAndSearch() {
    var mode = elMode.value;
    var q = normalizeText(elSearch.value).toLowerCase();
    var base = cardsAll.slice().filter(function(c) {
      if (mode.indexOf('topics-') === 0 || mode === 'topics-all') return c.kind === 'topic';
      if (mode === 'exam-1') return c.kind === 'exam' && c.session === '1';
      if (mode === 'exam-2') return c.kind === 'exam' && c.session === '2';
      return true;
    });
    var grpMatch = mode.match(/^topics-(\d+)$/);
    if (grpMatch) {
      var grp = grpMatch[1];
      base = base.filter(function(c) { return topicGroupForUrl(c.url) === grp; });
    }
    if (q) {
      base = base.filter(function(c) {
        return (c.title || '').toLowerCase().includes(q) || (c.parent || '').toLowerCase().includes(q);
      });
    }
    function toInt(x, fallback) { var n = parseInt(String(x || ''), 10); return isFinite(n) ? n : (fallback || 0); }
    base.sort(function(a, b) {
      if (a.kind === 'topic' && b.kind === 'topic') {
        var ao = toInt(a.nav_order, 9999); var bo = toInt(b.nav_order, 9999);
        if (ao !== bo) return ao - bo;
        return String(a.title || '').localeCompare(String(b.title || ''), 'ko');
      }
      if (a.kind === 'exam' && b.kind === 'exam') {
        var ar = toInt(a.round, 0); var br = toInt(b.round, 0); if (ar !== br) return br - ar;
        var as = toInt(a.session, 0); var bs = toInt(b.session, 0); if (as !== bs) return as - bs;
        var an = toInt(a.no, 0); var bn = toInt(b.no, 0); return an - bn;
      }
      return String(a.kind).localeCompare(String(b.kind));
    });
    cards = base;
    idx = 0;
    renderList();
    selectIndex(0, { scrollIntoView: true });
  }

  function renderList() {
    if (!cards.length) { elList.innerHTML = '<div class="domain-deck__item"><div class="domain-deck__item-title">결과가 없습니다.</div></div>'; setStatus(); clearDetail(); return; }
    var html = '';
    cards.forEach(function(c, i) {
      html += '<div class="domain-deck__item' + (i === idx ? ' is-active' : '') + '" data-idx="' + i + '">';
      html += '<div class="domain-deck__item-title">' + escapeHtml(c.title) + '</div>';
      html += '<div class="domain-deck__item-tagline"><span class="domain-deck__pill">' + escapeHtml(c.badge) + '</span></div>';
      html += '</div>';
    });
    elList.innerHTML = html;
    setStatus();
    Array.prototype.forEach.call(elList.querySelectorAll('.domain-deck__item[data-idx]'), function(node) {
      node.addEventListener('click', function() { var i = parseInt(node.getAttribute('data-idx') || '0', 10); selectIndex(i, { scrollIntoView: false }); });
    });
  }

  function clearDetail() { elTag.textContent = '-'; elTitle.textContent = '항목을 선택하세요'; elDef.innerHTML = '-'; elComponents.innerHTML = '-'; elMnemonic.innerHTML = '-'; elOpenLink.setAttribute('href', '#'); }
  function updateActiveRow() { Array.prototype.forEach.call(elList.querySelectorAll('.domain-deck__item[data-idx]'), function(node) { var i = parseInt(node.getAttribute('data-idx') || '0', 10); if (i === idx) node.classList.add('is-active'); else node.classList.remove('is-active'); }); }

  function selectIndex(i, opts) {
    if (!cards.length) return;
    if (i < 0) i = 0;
    if (i >= cards.length) i = cards.length - 1;
    idx = i;
    updateActiveRow();
    setStatus();
    var c = cards[idx];
    elTag.textContent = c.badge;
    elTitle.textContent = c.title;
    elOpenLink.setAttribute('href', c.url || '#');

    var isExam = c.kind === 'exam';
    if (root && root.classList) root.classList.toggle('domain-deck--exam', isExam);

    // exam: show only Quick Reference pane
    if (paneDef) paneDef.style.display = isExam ? 'none' : '';
    if (paneComponents) paneComponents.style.display = isExam ? 'none' : '';
    if (paneMnemonic) {
      if (isExam) paneMnemonic.classList.remove('domain-deck__pane--wide');
      else paneMnemonic.classList.add('domain-deck__pane--wide');
    }
    if (paneMnemonicTitle) paneMnemonicTitle.textContent = isExam ? '핵심 암기 (Quick Reference)' : mnemonicTitleDefault;

    // Fast-fill: topics use mnemonic, exams wait for page extract
    elMnemonic.innerHTML = isExam ? '불러오는 중…' : (c.mnemonic_html || (c.mnemonic_text ? escapeHtml(c.mnemonic_text) : '-'));
    elDef.innerHTML = '-';
    elComponents.innerHTML = '-';

    hydrateFromPage(c);
    if (opts && opts.scrollIntoView) { var active = elList.querySelector('.domain-deck__item.is-active'); if (active && active.scrollIntoView) active.scrollIntoView({ block: 'nearest' }); }
  }

  function parseExamHtml(htmlText) {
    var parser = new DOMParser(); var doc = parser.parseFromString(htmlText, 'text/html'); var rows = doc.querySelectorAll('#examTable tbody tr'); var out = [];
    rows.forEach(function(tr) { var tds = tr.querySelectorAll('td'); if (!tds || tds.length < 7) return; var a = tds[4].querySelector('a'); if (!a) return; var mnemonicText = normalizeText(tds[6].textContent); if (!mnemonicText || mnemonicText === '-') return;
      out.push({ kind: 'exam', round: normalizeText(tds[0].textContent), session: normalizeText(tds[2].textContent), no: normalizeText(tds[3].textContent), title: normalizeText(a.textContent), url: a.getAttribute('href') || '', badge: normalizeText(tds[0].textContent) + '회 · ' + normalizeText(tds[2].textContent) + '교시', mnemonic_text: mnemonicText, mnemonic_html: (tds[6].innerHTML || '').trim() });
    });
    return out;
  }

  function findHeading(doc, keyword) { var headings = Array.prototype.slice.call(doc.querySelectorAll('h1,h2,h3,h4')); return headings.find(function(h) { return normalizeText(h.textContent).includes(keyword); }) || null; }
  function extractDefinition(doc) { var h = findHeading(doc, '개념 정의') || findHeading(doc, '개념') || findHeading(doc, '정의'); if (!h) return ''; var el = h.nextElementSibling; while (el && el.tagName === 'HR') el = el.nextElementSibling; if (!el) return ''; if (el.tagName === 'TABLE') { var firstRow = el.querySelector('tbody tr'); if (!firstRow) return ''; var tds = firstRow.querySelectorAll('td'); if (tds && tds.length >= 2) return normalizeText(tds[1].textContent); return normalizeText(firstRow.textContent); } if (el.tagName === 'BLOCKQUOTE') return normalizeText(el.textContent); return normalizeText(el.textContent); }
  function extractComponentsTables(doc) { var h = findHeading(doc, '구성요소') || findHeading(doc, '기술요소'); if (!h) return ''; var el = h.nextElementSibling; var tables = []; var guard = 0; while (el && guard < 50) { if (/^H[1-6]$/.test(el.tagName)) break; if (el.tagName === 'TABLE') tables.push(el); var innerTables = el.querySelectorAll ? el.querySelectorAll('table') : []; if (innerTables && innerTables.length) innerTables.forEach(function(t) { if (tables.indexOf(t) === -1) tables.push(t); }); if (tables.length >= 2) break; el = el.nextElementSibling; guard += 1; } if (!tables.length) return ''; return tables.slice(0, 2).map(function(t) { return t.outerHTML; }).join('\n'); }
  function normalizeMnemonicFallback(doc) { var headings = Array.prototype.slice.call(doc.querySelectorAll('h1,h2,h3,h4')); var target = headings.find(function(h) { return normalizeText(h.textContent).includes('암기'); }); if (!target) return null; var el = target.nextElementSibling; var tries = 0; while (el && tries < 6) { var codes = el.querySelectorAll ? el.querySelectorAll('code') : []; if (codes && codes.length) return el.innerHTML.trim(); if (el.tagName === 'TABLE') return el.outerHTML; el = el.nextElementSibling; tries += 1; } return null; }

  function extractQuickReferenceHtml(doc) {
    var h = findHeading(doc, '핵심 암기') || findHeading(doc, 'Quick Reference') || findHeading(doc, 'Quick');
    if (!h) return '';
    var el = h.nextElementSibling;
    while (el && (el.tagName === 'HR')) el = el.nextElementSibling;
    if (!el) return '';
    var parts = [];
    var guard = 0;
    while (el && guard < 10) {
      if (/^H[1-6]$/.test(el.tagName)) break;
      if (el.tagName === 'HR') break;
      parts.push(el.outerHTML);
      if (el.tagName === 'BLOCKQUOTE') break;
      if (parts.length >= 2) break;
      el = el.nextElementSibling;
      guard += 1;
    }
    return parts.join('\n');
  }

  function hydrateFromPage(card) {
    if (!card || !card.url) return;
    if (pageCache.has(card.url)) { applyExtracted(pageCache.get(card.url)); return; }
    var isExam = card.kind === 'exam';
    if (!isExam) {
      elDef.innerHTML = '불러오는 중…'; elComponents.innerHTML = '불러오는 중…';
    }
    fetch(card.url, { credentials: 'same-origin' }).then(function(res) { return res.text(); }).then(function(html) {
      var parser = new DOMParser(); var doc = parser.parseFromString(html, 'text/html');
      var quickrefHtml = extractQuickReferenceHtml(doc);
      var definition = isExam ? '' : extractDefinition(doc);
      var componentsHtml = isExam ? '' : extractComponentsTables(doc);
      var mnemonic = card.mnemonic_html || normalizeMnemonicFallback(doc) || '';
      var payload = { url: card.url, quickref_html: quickrefHtml, definition: definition, components_html: componentsHtml, mnemonic_html: mnemonic };
      pageCache.set(card.url, payload); applyExtracted(payload);
    }).catch(function() {
      if (isExam) elMnemonic.innerHTML = '-';
      else { elDef.innerHTML = '-'; elComponents.innerHTML = '-'; }
    });
  }

  function applyExtracted(payload) {
    if (!payload || !cards.length) return;
    var cur = cards[idx];
    if (!cur || cur.url !== payload.url) return;

    if (cur.kind === 'exam') {
      // exam: show only Quick Reference (fallback to mnemonic if not found)
      if (payload.quickref_html) elMnemonic.innerHTML = payload.quickref_html;
      else elMnemonic.innerHTML = cur.mnemonic_html || (cur.mnemonic_text ? escapeHtml(cur.mnemonic_text) : '-');
      return;
    }

    elDef.innerHTML = payload.definition ? escapeHtml(payload.definition) : '-';
    elComponents.innerHTML = payload.components_html ? payload.components_html : '-';
    if (!cur.mnemonic_html || !cur.mnemonic_text) {
      if (payload.mnemonic_html) elMnemonic.innerHTML = payload.mnemonic_html;
    }
  }

  function loadSources() {
    elStatus.textContent = '데이터 로딩…';
    var promises = [
      fetch(topicsUrl, { credentials: 'same-origin' }).then(function(r) { return r.json(); }).then(function(j) {
        topicRows = (Array.isArray(j) ? j : []).map(function(p) { return { kind: 'topic', title: normalizeText(p.title), url: p.url, parent: p.parent, badge: shortParentLabel(p.parent || domain + ' 토픽'), nav_order: p.nav_order, mnemonic_text: '' }; });
      })
    ];
    if (examUrl) {
      promises.push(fetch(examUrl, { credentials: 'same-origin' }).then(function(r) { return r.text(); }).then(function(t) { examRows = parseExamHtml(t); }));
    }
    return Promise.all(promises);
  }

  function init() {
    try { var params = new URLSearchParams(window.location.search || ''); var qsDeck = params.get('deck') || params.get('mode'); if (qsDeck && elMode.querySelector('option[value="' + qsDeck + '"]')) { elMode.value = qsDeck; safeSet(STORAGE_PREFIX + 'prefs', { mode: qsDeck, search: '' }); } } catch (e) {}
    var prefs = safeGet(STORAGE_PREFIX + 'prefs', {}); if (prefs && typeof prefs === 'object') { if (prefs.mode) elMode.value = prefs.mode; if (prefs.search) elSearch.value = String(prefs.search); }
    loadSources().then(function() { cardsAll = examRows.concat(topicRows); elStatus.textContent = '준비 완료'; applyModeAndSearch(); }).catch(function(err) { elStatus.textContent = '로딩 실패: ' + (err && err.message ? err.message : 'unknown'); clearDetail(); });
    elMode.addEventListener('change', function() { safeSet(STORAGE_PREFIX + 'prefs', { mode: elMode.value, search: elSearch.value }); applyModeAndSearch(); });
    elSearch.addEventListener('input', function() { safeSet(STORAGE_PREFIX + 'prefs', { mode: elMode.value, search: elSearch.value }); if (window.__domainDeckSearchTimer) clearTimeout(window.__domainDeckSearchTimer); window.__domainDeckSearchTimer = setTimeout(applyModeAndSearch, 180); });
    btnPrev.addEventListener('click', function() { selectIndex(idx - 1, { scrollIntoView: true }); });
    btnNext.addEventListener('click', function() { selectIndex(idx + 1, { scrollIntoView: true }); });
    window.addEventListener('keydown', function(e) { if (e.defaultPrevented) return; var ae = document.activeElement; if (ae) { var tag = (ae.tagName || '').toLowerCase(); if (tag === 'input' || tag === 'textarea' || tag === 'select') return; if (ae.isContentEditable) return; } if (e.key === 'ArrowDown') { e.preventDefault(); selectIndex(idx + 1, { scrollIntoView: true }); } if (e.key === 'ArrowUp') { e.preventDefault(); selectIndex(idx - 1, { scrollIntoView: true }); } if (e.key === 'Enter') { var cur = cards[idx]; if (cur && cur.url) window.open(cur.url, '_blank', 'noopener'); } });
  }

  init();
})();
</script>

